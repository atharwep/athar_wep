<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø«Ø± | Ù…Ù†Ù‚Ø­ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª Ø§Ù„Ø°ÙƒÙŠ V3.0 - Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Cairo:wght@400;600;700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="protection.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>
    <script src="language_manager.js"></script>


    <style>
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .comparison-panel {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid var(--glass-border);
        }

        .comparison-panel.draft {
            border-color: #f59e0b;
        }

        .comparison-panel.requirements {
            border-color: #2563eb;
        }

        .gap-analysis {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
            border-right: 5px solid #ef4444;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .improvement-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .improvement-card:hover {
            border-color: var(--primary);
            transform: translateX(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .improvement-card.selected {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.02));
        }

        .improvement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .improvement-badge {
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .improvement-badge.critical {
            background: #ef4444;
        }

        .improvement-badge.important {
            background: #f59e0b;
        }

        .improvement-badge.optional {
            background: #6366f1;
        }

        .interactive-stepper {
            display: flex;
            justify-content: space-between;
            margin: 40px 0;
            position: relative;
        }

        .interactive-stepper::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 10%;
            right: 10%;
            height: 3px;
            background: var(--glass-border);
            z-index: 0;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            flex: 1;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 3px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step-item.active .step-circle {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.2);
        }

        .step-item.completed .step-circle {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .step-label {
            margin-top: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .step-item.active .step-label {
            color: var(--primary);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--glass-border);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: width 0.5s ease;
        }

        .diff-highlight {
            background: rgba(16, 185, 129, 0.2);
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 600;
        }

        .overlay-base {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
            padding: 20px;
        }

        .preview-toolbar {
            width: 100%;
            max-width: 900px;
            background: #0f172a;
            padding: 15px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid var(--accent);
        }

        .refine-paper {
            background: white;
            width: 100%;
            max-width: 900px;
            min-height: 800px;
            padding: 60px;
            border-radius: 0 0 15px 15px;
            color: #1e293b;
            line-height: 2.2;
            font-family: 'Cairo', sans-serif;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
        }

        .proposal-section {
            border-bottom: 2px solid #f1f5f9;
            padding: 15px 0;
            margin-bottom: 15px;
        }

        .proposal-section h3 {
            color: var(--primary);
            margin: 0;
            font-weight: 800;
            font-size: 1.35rem;
        }

        .report-card {
            background: #f8fafc;
            border-right: 5px solid var(--primary);
            padding: 15px;
            border-radius: 10px;
        }

        .report-card strong {
            display: block;
            color: var(--primary);
            margin-bottom: 5px;
        }
    </style>
</head>

<body class="light-theme">
    <!-- Preview Modal -->
    <div id="previewModal" class="overlay-base">
        <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <div class="preview-toolbar">
                <div style="color:white; font-weight:bold;" data-i18n="ai_output">ğŸ’ Ù…Ø®Ø±Ø¬Ø§Øª Ù…Ù†ØµØ© Ø£Ø«Ø± V3.0</div>
                <div style="display:flex; gap:12px;">
                    <button id="exportWordBtn" class="btn btn-primary" style="background:#2563eb; border:none;"
                        data-i18n="btn_export_word">ØªØ­Ù…ÙŠÙ„
                        Word ğŸ“¥</button>
                    <button onclick="document.getElementById('previewModal').style.display='none'" class="btn btn-ghost"
                        style="color:white;" data-i18n="btn_close">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
            <div id="refineOutput" class="refine-paper" contenteditable="true"></div>
        </div>
    </div>

    <div class="container">
        <nav>
            <div class="logo-container">
                <a href="index.html" style="text-decoration:none; display:flex; align-items:center; gap:20px;">
                    <img src="ØªÙ†Ø²ÙŠÙ„.jpg" alt="Logo" id="mainLogo" style="width:50px; border-radius:8px;">
                    <div class="logo">Ø£Ø«Ù€Ù€Ù€Ù€Ù€Ø±</div>
                </a>
            </div>
            <div class="nav-actions">
                <a href="index.html" class="btn btn-ghost" data-i18n="nav_home">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <div class="dropdown">
                    <button class="btn btn-ghost">ğŸ“‚ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ</button>
                    <div class="dropdown-content">
                        <a href="career_path.html">ğŸš€ Ù…Ø³Ø§Ø±Ùƒ Ø§Ù„Ù…Ù‡Ù†ÙŠ</a>
                        <a href="job_prep.html">ğŸ¯ Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ù„Ù…Ù‚Ø§Ø¨Ù„Ø§Øª</a>
                        <a href="skill_dev.html">ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø¯Ø±Ø§Øª</a>
                        <a href="cv_improved.html">ğŸ¤– Ø³ÙŠØ±Ø© ATS Ø§Ù„Ø°ÙƒÙŠØ©</a>
                    </div>
                </div>
                <a href="refine_v3.html" class="btn btn-ghost" data-i18n="nav_refine">âš¡ Ø§Ù„Ù…Ù†Ù‚Ø­ Ø§Ù„Ø°ÙƒÙŠ</a>
                <a href="library_v3.html" class="btn btn-ghost" data-i18n="nav_lib">ğŸ“š Ø§Ù„Ù…ÙƒØªØ¨Ø©</a>
                <!-- <a href="whats_new.html" class="btn btn-ghost" data-i18n="nav_new">âœ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯</a> -->
                <button id="globalLangToggle" class="btn btn-ghost" onclick="LangManager.toggleLanguage()">English
                    ğŸ‡ºğŸ‡¸</button>
                <button id="themeToggle" class="btn btn-ghost">ğŸŒ“</button>
            </div>
        </nav>

        <main class="glass-card" style="margin-top:20px; padding:40px;">
            <h1 style="font-weight:900; color:var(--primary); text-align:center; margin-bottom:15px;"
                data-i18n="refine_title">âœï¸ Ø§Ù„Ù…Ø·ÙˆØ± ÙˆØ§Ù„Ù…Ù†Ù‚Ø­
                Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ V3.0</h1>
            <p style="text-align:center; color:var(--text-secondary); margin-bottom:40px;" data-i18n="refine_subtitle">
                ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ù„Ù„ÙØ¬ÙˆØ§Øª ÙˆØªØ­Ø³ÙŠÙ†Ø§Øª
                ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ø®ØµØµØ©</p>

            <!-- Interactive Stepper -->
            <div class="interactive-stepper">
                <div class="step-item active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label" data-i18n="step_upload">Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª</div>
                </div>
                <div class="step-item" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label" data-i18n="step_analysis">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†</div>
                </div>
                <div class="step-item" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label" data-i18n="step_improve">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª</div>
                </div>
                <div class="step-item" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label" data-i18n="step_review">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 25%;"></div>
            </div>

            <!-- Step 1: Upload Files -->
            <div id="step1" class="step-content">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px; margin-bottom:30px;">
                    <div class="form-group">
                        <label>ğŸ“„ Ù…Ø³ÙˆØ¯Ø© Ù…Ø´Ø±ÙˆØ¹Ùƒ</label>
                        <input type="file" id="f1" accept=".docx,.pdf" style="margin-bottom:10px; width:100%;">
                        <textarea id="t1" rows="12" placeholder="Ø¶Ø¹ Ù…Ø³ÙˆØ¯Ø© Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>ğŸ¯ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…Ø§Ù†Ø­</label>
                        <input type="file" id="f2" accept=".docx,.pdf" style="margin-bottom:10px; width:100%;">
                        <textarea id="t2" rows="12" placeholder="Ø£Ø¯Ø®Ù„ Ø´Ø±ÙˆØ· Ø£Ùˆ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…Ø§Ù†Ø­..."></textarea>
                    </div>
                </div>
                <button id="analyzeBtn" class="btn btn-primary"
                    style="width:100%; padding:20px; font-size:1.2rem; border-radius:15px;">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†
                    âš¡</button>
            </div>

            <!-- Step 2: Comparison Analysis -->
            <div id="step2" class="step-content" style="display:none;">
                <h2 style="color:var(--primary); margin-bottom:20px;">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†</h2>

                <div class="comparison-container">
                    <div class="comparison-panel draft">
                        <h3 style="color:#f59e0b; margin-bottom:15px;">ğŸ“„ Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
                        <div id="draftSummary"></div>
                    </div>
                    <div class="comparison-panel requirements">
                        <h3 style="color:#2563eb; margin-bottom:15px;">ğŸ¯ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù†Ø­</h3>
                        <div id="requirementsSummary"></div>
                    </div>
                </div>

                <div class="gap-analysis">
                    <h3 style="color:#ef4444; margin-bottom:15px;">ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ¬ÙˆØ§Øª</h3>
                    <div id="gapAnalysis"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-ghost" onclick="goToStep(1)">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
                    <button class="btn btn-primary" onclick="goToStep(3)">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª â¡ï¸</button>
                </div>
            </div>

            <!-- Step 3: Select Improvements -->
            <div id="step3" class="step-content" style="display:none;">
                <h2 style="color:var(--primary); margin-bottom:20px;">âœ¨ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</h2>
                <p style="color:var(--text-secondary); margin-bottom:25px;">Ø§Ø®ØªØ± Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ø¹Ù„Ù‰
                    Ù…Ø´Ø±ÙˆØ¹Ùƒ (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„ Ø£Ùˆ Ø¨Ø¹Ø¶Ù‡Ø§)</p>

                <div id="improvementsContainer"></div>

                <div class="action-buttons">
                    <button class="btn btn-ghost" onclick="goToStep(2)">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
                    <button class="btn btn-primary" id="applyImprovementsBtn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© âš¡</button>
                </div>
            </div>

            <!-- Step 4: Final Review -->
            <div id="step4" class="step-content" style="display:none;">
                <h2 style="color:var(--primary); margin-bottom:20px;">âœ… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
                <div id="finalReview" style="background:white; padding:30px; border-radius:12px; color:#1e293b;">
                </div>

                <div class="action-buttons">
                    <button class="btn btn-ghost" onclick="goToStep(3)">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn btn-primary" id="showPreviewBtn">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ğŸ‰</button>
                    <button class="btn btn-primary" id="saveLocalBtn" style="background:var(--accent);">ğŸ’¾ Ø­ÙØ¸
                        Ù…Ø­Ù„ÙŠØ§Ù‹</button>
                </div>
            </div>
        </main>
    </div>

    <script src="js/config.js"></script>
    <script>
        const BRIDGE = AtharConfig.getBridgeUrl();

        let state = {
            currentStep: 1,
            draftText: '',
            requirementsText: '',
            analysis: null,
            improvements: [],
            selectedImprovements: [],
            finalProposal: ''
        };

        // File reading functions
        async function readFile(file, targetId) {
            const area = document.getElementById(targetId);
            area.value = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ...";
            try {
                if (file.name.endsWith('.pdf')) {
                    const doc = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                    let text = "";
                    for (let i = 1; i <= doc.numPages; i++) {
                        const pg = await doc.getPage(i);
                        const content = await pg.getTextContent();
                        text += content.items.map(s => s.str).join(" ") + "\n";
                    }
                    area.value = text;
                } else {
                    const res = await mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
                    area.value = res.value;
                }
            } catch (e) {
                area.value = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©";
            }
        }

        document.getElementById('f1').onchange = (e) => readFile(e.target.files[0], 't1');
        document.getElementById('f2').onchange = (e) => readFile(e.target.files[0], 't2');

        // AI Call Function
        async function callAI(prompt) {
            const payload = {
                model: "llama-3.3-70b-versatile",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.4
            };

            try {
                const res = await fetch(BRIDGE + "?action=ai", {
                    method: "POST",
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("NETWORK_RESPONSE_NOT_OK");

                const bridgeRes = await res.json();
                if (bridgeRes.status === "error") throw new Error(bridgeRes.message);

                return bridgeRes.data; // This is the AI's content string
            } catch (e) {
                console.error("AI Bridge Error:", e);
                return null;
            }
        }

        // Parse AI Response
        function parseAIResponse(aiContentString) {
            if (!aiContentString) return null;

            try {
                // Find the JSON block within the response
                const cleanJson = aiContentString.replace(/```json\s*|```\s*/gi, "").trim();
                const jsonMatch = cleanJson.match(/\{[\s\S]*\}/);

                if (!jsonMatch) {
                    console.error("No JSON block found in content:", aiContentString);
                    return null;
                }

                const data = JSON.parse(jsonMatch[0]);
                if (data.error) {
                    alert("Ø®Ø·Ø£ Ù…Ù† Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©: " + (data.error.message || "ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„"));
                    return null;
                }
                return data;
            } catch (e) {
                console.error("JSON Parse Error:", e);
                alert("ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø±Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                return null;
            }
        }

        // Step Navigation
        function goToStep(step) {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).style.display = 'none';
                document.querySelector(`.step-item[data-step="${i}"]`).classList.remove('active', 'completed');
            }

            // Show current step
            document.getElementById(`step${step}`).style.display = 'block';
            document.querySelector(`.step-item[data-step="${step}"]`).classList.add('active');

            // Mark previous steps as completed
            for (let i = 1; i < step; i++) {
                document.querySelector(`.step-item[data-step="${i}"]`).classList.add('completed');
            }

            // Update progress bar
            const progress = (step / 4) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            state.currentStep = step;
        }

        // Analyze Button
        document.getElementById('analyzeBtn').onclick = async () => {
            const draft = document.getElementById('t1').value;
            const requirements = document.getElementById('t2').value;

            if (draft.length < 30) {
                alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.");
                return;
            }

            const btn = document.getElementById('analyzeBtn');
            btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†...";
            btn.disabled = true;

            state.draftText = draft;
            state.requirementsText = requirements;

            const prompt = `Analyze this project draft against donor requirements. Return JSON:
{
  "draftSummary": "Brief summary of the draft in Arabic",
  "requirementsSummary": "Brief summary of requirements in Arabic",
  "gaps": ["Gap 1", "Gap 2", "Gap 3"],
  "improvements": [
    {
      "title": "Improvement title in Arabic",
      "description": "Description in Arabic",
      "priority": "critical|important|optional",
      "impact": "High|Medium|Low"
    }
  ]
}

Draft: ${draft.substring(0, 2000)}
Requirements: ${requirements.substring(0, 2000)}`;

            const response = await callAI(prompt);
            const analysis = parseAIResponse(response);

            if (analysis) {
                state.analysis = analysis;

                // Populate comparison
                document.getElementById('draftSummary').innerHTML = `<p style="line-height:1.8;">${analysis.draftSummary || draft.substring(0, 300) + '...'}</p>`;
                document.getElementById('requirementsSummary').innerHTML = `<p style="line-height:1.8;">${analysis.requirementsSummary || requirements.substring(0, 300) + '...'}</p>`;

                // Populate gaps
                const gapsHtml = (analysis.gaps || []).map(gap =>
                    `<div style="margin:10px 0; padding:10px; background:rgba(255,255,255,0.5); border-radius:8px;">
                        <strong>â€¢</strong> ${gap}
                    </div>`
                ).join('');
                document.getElementById('gapAnalysis').innerHTML = gapsHtml || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¬ÙˆØ§Øª ÙƒØ¨ÙŠØ±Ø©</p>';

                // Store improvements
                state.improvements = analysis.improvements || [];

                goToStep(2);
            } else {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            }

            btn.innerText = "Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù† âš¡";
            btn.disabled = false;
        };

        // When moving to step 3, render improvements
        const originalGoToStep = goToStep;
        goToStep = function (step) {
            if (step === 3 && state.improvements.length > 0) {
                renderImprovements();
            }
            originalGoToStep(step);
        };

        function renderImprovements() {
            const container = document.getElementById('improvementsContainer');
            container.innerHTML = state.improvements.map((imp, idx) => `
                <div class="improvement-card" data-idx="${idx}" onclick="toggleImprovement(${idx})">
                    <div class="improvement-header">
                        <h4 style="margin:0; color:var(--primary);">${imp.title}</h4>
                        <span class="improvement-badge ${imp.priority}">${getPriorityLabel(imp.priority)}</span>
                    </div>
                    <p style="color:#64748b; margin:10px 0;">${imp.description}</p>
                    <div style="display:flex; gap:10px; font-size:0.85rem;">
                        <span style="color:var(--text-secondary);">ğŸ“Š Ø§Ù„ØªØ£Ø«ÙŠØ±: <strong>${imp.impact}</strong></span>
                    </div>
                </div>
            `).join('');

            // Select all by default
            state.selectedImprovements = state.improvements.map((_, idx) => idx);
            state.selectedImprovements.forEach(idx => {
                document.querySelector(`.improvement-card[data-idx="${idx}"]`).classList.add('selected');
            });
        }

        function getPriorityLabel(priority) {
            const labels = {
                'critical': 'Ø­Ø±Ø¬',
                'important': 'Ù…Ù‡Ù…',
                'optional': 'Ø§Ø®ØªÙŠØ§Ø±ÙŠ'
            };
            return labels[priority] || 'Ø¹Ø§Ø¯ÙŠ';
        }

        function toggleImprovement(idx) {
            const card = document.querySelector(`.improvement-card[data-idx="${idx}"]`);
            const isSelected = state.selectedImprovements.includes(idx);

            if (isSelected) {
                state.selectedImprovements = state.selectedImprovements.filter(i => i !== idx);
                card.classList.remove('selected');
            } else {
                state.selectedImprovements.push(idx);
                card.classList.add('selected');
            }
        }

        // Apply Improvements
        document.getElementById('applyImprovementsBtn').onclick = async () => {
            if (state.selectedImprovements.length === 0) {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ­Ø³ÙŠÙ† ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
                return;
            }

            const btn = document.getElementById('applyImprovementsBtn');
            btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª...";
            btn.disabled = true;

            const selectedImps = state.selectedImprovements.map(idx => state.improvements[idx]);

            const prompt = `Apply these improvements to the project draft. Return the complete improved proposal in Arabic (500-800 words):

Draft: ${state.draftText.substring(0, 2000)}

Improvements to apply:
${selectedImps.map(imp => `- ${imp.title}: ${imp.description}`).join('\n')}

Return only the improved proposal text in Arabic.`;

            const response = await callAI(prompt);

            if (response) {
                // Extract text from response
                let improvedText = response;
                try {
                    const jsonMatch = response.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const data = JSON.parse(jsonMatch[0]);
                        if (data.choices && data.choices[0]) {
                            improvedText = data.choices[0].message.content;
                        } else if (data.aiResponse) {
                            improvedText = data.aiResponse;
                        }
                    }
                } catch (e) { }

                state.finalProposal = improvedText;
                document.getElementById('finalReview').innerHTML = `<div style="line-height:2;">${improvedText.replace(/\n/g, '<br>')}</div>`;

                goToStep(4);
            } else {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            }

            btn.innerText = "ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© âš¡";
            btn.disabled = false;
        };

        // Show Preview
        document.getElementById('showPreviewBtn').onclick = () => {
            document.getElementById('refineOutput').innerHTML = `
                <h1 style="text-align:center; color:var(--primary); margin-bottom:30px;">Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø§Ù„Ù…Ø·ÙˆØ±</h1>
                <div style="line-height:2.2;">${state.finalProposal.replace(/\n/g, '<br>')}</div>
            `;
            document.getElementById('previewModal').style.display = 'flex';
        };

        // Save Locally
        document.getElementById('saveLocalBtn').onclick = () => {
            const projectData = {
                date: new Date().toISOString(),
                draft: state.draftText,
                requirements: state.requirementsText,
                improvements: state.selectedImprovements.map(idx => state.improvements[idx]),
                finalProposal: state.finalProposal
            };

            // Save to localStorage
            const savedProjects = JSON.parse(localStorage.getItem('athar_refined_projects') || '[]');
            savedProjects.push(projectData);
            localStorage.setItem('athar_refined_projects', JSON.stringify(savedProjects));

            alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­!");
        };

        // Export to Word
        document.getElementById('exportWordBtn').onclick = async () => {
            ProtectionManager.verify(async () => {
                const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = window.docx;

                const doc = new Document({
                    sections: [{
                        children: [
                            new Paragraph({
                                text: "Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø§Ù„Ù…Ø·ÙˆØ± - Ø£Ø«Ø± V3.0",
                                heading: HeadingLevel.HEADING_1,
                                alignment: AlignmentType.CENTER
                            }),
                            new Paragraph({ text: "", spacing: { after: 400 } }),
                            ...state.finalProposal.split('\n').map(line =>
                                new Paragraph({
                                    text: line.trim(),
                                    spacing: { after: 200 }
                                })
                            )
                        ]
                    }]
                });

                const blob = await Packer.toBlob(doc);
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Athar_Refined_Proposal_${Date.now()}.docx`;
                a.click();
            });
        };
    </script>
</body>

</html>