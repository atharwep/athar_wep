<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø«Ø± | Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="js/modules/auth_guard.js"></script>
    <script src="js/modules/review_service.js"></script>
    <script src="protection.js"></script>
    <style>
        :root {
            --audit-color: #7c3aed;
            /* Purple */
        }

        .audit-header {
            background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }

        .page-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
        }

        .status-accepted {
            background: #16a34a;
        }

        .status-revision {
            background: #ea580c;
        }

        .status-rejected {
            background: #dc2626;
        }

        .flag-item {
            background: #fef2f2;
            border: 1px solid #fee2e2;
            color: #991b1b;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>

<body>
    <div class="audit-header">
        <div class="page-container" style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h1 style="margin:0;">ğŸ•µï¸ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„ØªØ¯Ù‚ÙŠÙ‚</h1>
                <p style="margin:5px 0 0; opacity:0.9;">Ø±Ø§Ø¬Ø¹ Ù…Ø³ÙˆØ¯Ø§ØªÙƒ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø§ØªÙ„Ø©.</p>
            </div>
            <a href="index.html" class="btn btn-ghost" style="color:white; border-color:white;">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </div>
    </div>

    <div class="page-container">
        <div style="background:white; padding:30px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
            <div style="display:grid; grid-template-columns: 3fr 1fr; gap:20px; margin-bottom:20px;">
                <div>
                    <label>Ù„ØµÙ‚ Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ø£Ùˆ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø±Ø§Ø¯ Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡):</label>
                    <textarea id="proposalText" rows="10" placeholder="Problem Statement, Approach, Budget Narrative..."
                        style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;"></textarea>
                </div>
                <div>
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù†Ø­ (Ù„Ø¶Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±):</label>
                    <input type="text" id="donorName" placeholder="E.g. USAID, ECHO..."
                        style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;">

                    <div style="background:#f8fafc; padding:15px; border-radius:8px; font-size:0.9rem; color:#64748b;">
                        â„¹ï¸ Ø³ÙŠØªÙ… Ø§Ù„ÙØ­Øµ Ø¨Ø­Ø«Ø§Ù‹ Ø¹Ù†:
                        <ul style="padding-right:20px; margin-bottom:0;">
                            <li>ÙƒÙ„Ù…Ø§Øª Ù…Ø­Ø¸ÙˆØ±Ø©</li>
                            <li>ØªÙ†Ø§Ù‚Ø¶Ø§Øª Ù…Ù†Ø·Ù‚ÙŠØ©</li>
                            <li>Ø¶Ø¹Ù ÙÙŠ Ø§Ù„ØµÙŠØ§ØºØ©</li>
                        </ul>
                    </div>
                </div>
            </div>
            <button id="reviewBtn" onclick="runReview()" class="btn btn-primary"
                style="width:100%; background:var(--audit-color);">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ğŸ”</button>
        </div>

        <div id="reportCard"
            style="display:none; margin-top:30px; background:white; border-radius:15px; overflow:hidden; box-shadow:0 10px 20px rgba(0,0,0,0.1);">
            <div
                style="padding:20px; background:#f3f4f6; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2>
                <div id="scoreBadge" style="font-size:1.5rem; font-weight:900; color:var(--audit-color);"></div>
            </div>

            <div style="padding:30px;">
                <div style="text-align:center; margin-bottom:30px;">
                    <span id="statusLabel" class="status-badge"></span>
                    <p id="verdict" style="margin-top:10px; font-weight:bold;"></p>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                    <div>
                        <h3 style="color:#b91c1c;">ğŸš© Ø¥Ø´Ø§Ø±Ø§Øª Ø­Ù…Ø±Ø§Ø¡ (Critical Flags)</h3>
                        <div id="flagsList"></div>
                    </div>
                    <div>
                        <h3 style="color:#0f766e;">âœ… Ø§Ù„Ø§ØªØ³Ø§Ù‚ ÙˆØ§Ù„Ù…Ù†Ø·Ù‚</h3>
                        <p id="consistencyText" style="background:#f0fdfa; padding:15px; border-radius:8px;"></p>

                        <h4 style="margin-top:20px;">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Ø¨Ø±Ø©</h4>
                        <p id="toneText"></p>
                    </div>
                </div>

                <div style="margin-top:30px;">
                    <h3 style="color:#d97706;">ğŸ› ï¸ ØªØ­Ø³ÙŠÙ†Ø§Øª Ù…Ù‚ØªØ±Ø­Ø©</h3>
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#fff7ed; text-align:right;">
                                <th style="padding:10px;">Ø§Ù„Ù‚Ø³Ù…</th>
                                <th style="padding:10px;">Ø§Ù„ØªØ­Ø³ÙŠÙ†</th>
                            </tr>
                        </thead>
                        <tbody id="improvementsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const service = new ProposalReviewService();

        async function runReview() {
            const text = document.getElementById('proposalText').value;
            const donor = document.getElementById('donorName').value;

            if (!text) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ");

            const btn = document.getElementById('reviewBtn');
            btn.disabled = true;
            btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯Ù‚ÙŠÙ‚... â³";

            try {
                const result = await service.reviewProposal(text, donor);

                // Display
                document.getElementById('scoreBadge').innerText = result.score;

                const statusSpan = document.getElementById('statusLabel');
                statusSpan.innerText = result.status;
                statusSpan.className = `status-badge ${result.status === 'Accepted' ? 'status-accepted' : (result.status === 'Rejected' ? 'status-rejected' : 'status-revision')}`;

                document.getElementById('verdict').innerText = result.final_verdict;

                document.getElementById('flagsList').innerHTML = (result.critical_flags || []).map(f => `<div class="flag-item">ğŸš« ${f}</div>`).join('') || "âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ Ø®Ø·ÙŠØ±Ø©";

                document.getElementById('consistencyText').innerText = result.consistency_check;
                document.getElementById('toneText').innerText = result.tone_analysis;

                document.getElementById('improvementsTable').innerHTML = (result.improvements || []).map(i => `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:10px; font-weight:bold;">${i.section}</td>
                        <td style="padding:10px;">${i.suggestion}</td>
                    </tr>
                `).join('');

                document.getElementById('reportCard').style.display = 'block';
                window.scrollTo({ top: document.getElementById('reportCard').offsetTop, behavior: 'smooth' });

            } catch (e) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = "Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ğŸ”";
            }
        }
    </script>
</body>

</html>