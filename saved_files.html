<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø«Ø± | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="language_manager.js"></script>

    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>

    <style>
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .file-card {
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
        }

        .file-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .file-type-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .file-type-badge.project {
            background: #10b981;
        }

        .file-type-badge.cv {
            background: #f59e0b;
        }

        .file-type-badge.refined {
            background: #6366f1;
        }

        .file-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 10px;
            padding-left: 80px;
        }

        .file-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .file-actions button {
            flex: 1;
            padding: 8px 15px;
            font-size: 0.85rem;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>

<body class="light-theme">
    <div class="container">
        <nav>
            <div class="logo-container">
                <a href="index.html" style="text-decoration:none; display:flex; align-items:center; gap:20px;">
                    <img src="ØªÙ†Ø²ÙŠÙ„.jpg" alt="Logo" id="mainLogo">
                    <div>
                        <div class="logo">Ø£Ø«Ù€Ù€Ù€Ù€Ù€Ø±</div>
                        <div class="logo-slogan">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</div>
                    </div>
                </a>
            </div>
            <div class="nav-actions">
                <a href="index.html" class="btn btn-ghost" data-i18n="nav_home">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <a href="cv_improved.html" class="btn btn-ghost" data-i18n="nav_cv">ğŸ“„ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</a>
                <a href="library_v3.html" class="btn btn-ghost" data-i18n="nav_lib">ğŸ“š Ø§Ù„Ù…ÙƒØªØ¨Ø©</a>
                <button id="globalLangToggle" class="btn btn-ghost" onclick="LangManager.toggleLanguage()"
                    style="background:var(--primary); color:white;">English ğŸ‡ºğŸ‡¸</button>
            </div>
        </nav>

        <main style="margin-top: 40px;">
            <h1 style="font-weight:900; color:var(--primary); text-align:center; margin-bottom:15px;"
                data-i18n="saved_title">
                ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
            </h1>

            <p style="text-align:center; color:var(--text-secondary); margin-bottom:40px;">
                Ø¬Ù…ÙŠØ¹ Ù…Ø´Ø§Ø±ÙŠØ¹Ùƒ ÙˆØ³ÙŠØ±Ùƒ Ø§Ù„Ø°Ø§ØªÙŠØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ù…ØªØµÙØ­Ùƒ
            </p>

            <!-- Statistics -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="totalProjects">0</div>
                    <div class="stat-label">Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø­ÙÙˆØ¸Ø©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalCVs">0</div>
                    <div class="stat-label">Ø³ÙŠØ± Ø°Ø§ØªÙŠØ©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRefined">0</div>
                    <div class="stat-label">Ù…Ù‚ØªØ±Ø­Ø§Øª Ù…Ù†Ù‚Ø­Ø©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSize">0 KB</div>
                    <div class="stat-label">Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div style="display:flex; gap:15px; justify-content:center; margin-bottom:30px;">
                <button class="btn btn-primary" onclick="filterFiles('all')">Ø§Ù„ÙƒÙ„</button>
                <button class="btn btn-ghost" onclick="filterFiles('projects')">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button>
                <button class="btn btn-ghost" onclick="filterFiles('cvs')">Ø§Ù„Ø³ÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠØ©</button>
                <button class="btn btn-ghost" onclick="filterFiles('refined')">Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª Ø§Ù„Ù…Ù†Ù‚Ø­Ø©</button>
            </div>

            <!-- Files Grid -->
            <div id="filesGrid" class="files-grid"></div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display:none;">
                <div class="empty-state-icon">ğŸ“‚</div>
                <h3 style="color:var(--primary); margin-bottom:10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø­ÙÙˆØ¸Ø©</h3>
                <p>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ø£Ùˆ Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ© ÙˆØ³ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                <div style="margin-top:30px;">
                    <a href="index.html" class="btn btn-primary">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</a>
                </div>
            </div>

            <!-- Clear All Button -->
            <div style="text-align:center; margin-top:40px;">
                <button id="clearAllBtn" class="btn btn-ghost" style="color:#ef4444; border-color:#ef4444;">
                    ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
                </button>
            </div>
        </main>
    </div>

    <script>
        let allFiles = [];
        let currentFilter = 'all';

        // Load all saved files
        function loadFiles() {
            allFiles = [];

            // Load projects
            const projects = JSON.parse(localStorage.getItem('athar_saved_projects') || '[]');
            projects.forEach((project, idx) => {
                allFiles.push({
                    type: 'project',
                    id: 'project_' + idx,
                    title: project.projectInfo?.partnerName || 'Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
                    date: project.date || new Date().toISOString(),
                    data: project
                });
            });

            // Load CVs
            const cvs = JSON.parse(localStorage.getItem('athar_saved_cvs') || '[]');
            cvs.forEach((cv, idx) => {
                allFiles.push({
                    type: 'cv',
                    id: 'cv_' + idx,
                    title: 'Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ© ' + (idx + 1),
                    date: cv.date || new Date().toISOString(),
                    data: cv
                });
            });

            // Load refined proposals
            const refined = JSON.parse(localStorage.getItem('athar_refined_projects') || '[]');
            refined.forEach((ref, idx) => {
                allFiles.push({
                    type: 'refined',
                    id: 'refined_' + idx,
                    title: 'Ù…Ù‚ØªØ±Ø­ Ù…Ù†Ù‚Ø­ ' + (idx + 1),
                    date: ref.date || new Date().toISOString(),
                    data: ref
                });
            });

            // Update statistics
            updateStats();

            // Render files
            renderFiles();
        }

        function updateStats() {
            const projects = allFiles.filter(f => f.type === 'project');
            const cvs = allFiles.filter(f => f.type === 'cv');
            const refined = allFiles.filter(f => f.type === 'refined');

            document.getElementById('totalProjects').innerText = projects.length;
            document.getElementById('totalCVs').innerText = cvs.length;
            document.getElementById('totalRefined').innerText = refined.length;

            // Calculate total size
            const totalSize = JSON.stringify(allFiles).length;
            document.getElementById('totalSize').innerText = (totalSize / 1024).toFixed(2) + ' KB';
        }

        function filterFiles(filter) {
            currentFilter = filter;

            // Update button states
            document.querySelectorAll('.btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-ghost');
            });
            event.target.classList.remove('btn-ghost');
            event.target.classList.add('btn-primary');

            renderFiles();
        }

        function renderFiles() {
            const grid = document.getElementById('filesGrid');
            const emptyState = document.getElementById('emptyState');

            let filesToShow = allFiles;

            if (currentFilter !== 'all') {
                const typeMap = {
                    'projects': 'project',
                    'cvs': 'cv',
                    'refined': 'refined'
                };
                filesToShow = allFiles.filter(f => f.type === typeMap[currentFilter]);
            }

            if (filesToShow.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = filesToShow.map(file => {
                const date = new Date(file.date);
                const formattedDate = date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const typeLabels = {
                    'project': 'Ù…Ø´Ø±ÙˆØ¹',
                    'cv': 'Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ©',
                    'refined': 'Ù…Ù‚ØªØ±Ø­ Ù…Ù†Ù‚Ø­'
                };

                return `
                    <div class="file-card">
                        <span class="file-type-badge ${file.type}">${typeLabels[file.type]}</span>
                        <div class="file-title">${file.title}</div>
                        <div class="file-date">ğŸ“… ${formattedDate}</div>
                        <div class="file-actions">
                            <button class="btn btn-primary btn-sm" onclick="viewFile('${file.id}')">Ø¹Ø±Ø¶</button>
                            <button class="btn btn-ghost btn-sm" onclick="downloadFile('${file.id}')">ØªØ­Ù…ÙŠÙ„</button>
                            <button class="btn btn-ghost btn-sm" style="color:#ef4444;" onclick="deleteFile('${file.id}')">Ø­Ø°Ù</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewFile(id) {
            const file = allFiles.find(f => f.id === id);
            if (!file) return;

            // Create modal for viewing
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; display:flex; align-items:center; justify-content:center; padding:20px; overflow-y:auto;';

            let content = '';

            if (file.type === 'project') {
                content = `
                    <div style="background:white; color:#333; padding:40px; border-radius:15px; max-width:800px; width:100%;">
                        <h2 style="color:var(--primary); margin-bottom:20px;">${file.title}</h2>
                        <div style="line-height:2;">
                            ${JSON.stringify(file.data, null, 2).replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
            } else if (file.type === 'cv') {
                content = `
                    <div style="background:white; color:#333; padding:40px; border-radius:15px; max-width:800px; width:100%;">
                        <h2 style="color:var(--primary); margin-bottom:20px;">${file.title}</h2>
                        ${file.data.data?.html || '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰</p>'}
                    </div>
                `;
            } else if (file.type === 'refined') {
                content = `
                    <div style="background:white; color:#333; padding:40px; border-radius:15px; max-width:800px; width:100%;">
                        <h2 style="color:var(--primary); margin-bottom:20px;">${file.title}</h2>
                        <div style="line-height:2;">
                            ${file.data.finalProposal?.replace(/\n/g, '<br>') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰'}
                        </div>
                    </div>
                `;
            }

            modal.innerHTML = `
                <div style="position:relative; max-width:900px; width:100%;">
                    <button onclick="this.closest('div').parentElement.remove()" 
                            style="position:absolute; top:-10px; left:-10px; background:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.5rem; z-index:1;">
                        âœ•
                    </button>
                    ${content}
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function downloadFile(id) {
            const file = allFiles.find(f => f.id === id);
            if (!file) return;

            const { Document, Packer, Paragraph, TextRun, HeadingLevel } = window.docx;

            let content = '';

            if (file.type === 'project') {
                content = JSON.stringify(file.data, null, 2);
            } else if (file.type === 'cv') {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = file.data.data?.html || '';
                content = tempDiv.textContent || tempDiv.innerText;
            } else if (file.type === 'refined') {
                content = file.data.finalProposal || '';
            }

            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({
                            text: file.title,
                            heading: HeadingLevel.HEADING_1
                        }),
                        ...content.split('\n').filter(line => line.trim()).map(line =>
                            new Paragraph({
                                text: line.trim(),
                                spacing: { after: 200 }
                            })
                        )
                    ]
                }]
            });

            const blob = await Packer.toBlob(doc);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${file.title}_${Date.now()}.docx`;
            a.click();
        }

        function deleteFile(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ')) return;

            const file = allFiles.find(f => f.id === id);
            if (!file) return;

            // Remove from localStorage
            if (file.type === 'project') {
                const projects = JSON.parse(localStorage.getItem('athar_saved_projects') || '[]');
                const idx = parseInt(id.split('_')[1]);
                projects.splice(idx, 1);
                localStorage.setItem('athar_saved_projects', JSON.stringify(projects));
            } else if (file.type === 'cv') {
                const cvs = JSON.parse(localStorage.getItem('athar_saved_cvs') || '[]');
                const idx = parseInt(id.split('_')[1]);
                cvs.splice(idx, 1);
                localStorage.setItem('athar_saved_cvs', JSON.stringify(cvs));
            } else if (file.type === 'refined') {
                const refined = JSON.parse(localStorage.getItem('athar_refined_projects') || '[]');
                const idx = parseInt(id.split('_')[1]);
                refined.splice(idx, 1);
                localStorage.setItem('athar_refined_projects', JSON.stringify(refined));
            }

            // Reload
            loadFiles();
        }

        document.getElementById('clearAllBtn').onclick = () => {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!')) return;

            localStorage.removeItem('athar_saved_projects');
            localStorage.removeItem('athar_saved_cvs');
            localStorage.removeItem('athar_refined_projects');

            loadFiles();
        };

        // Theme Toggle
        document.getElementById('themeToggle').onclick = () => {
            const isDark = document.body.classList.toggle('dark-theme');
            document.body.classList.toggle('light-theme', !isDark);
        };

        // Initialize
        loadFiles();
    </script>
</body>

</html>