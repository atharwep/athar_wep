<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø«Ø± | ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø®Ø¨Ø±Ø§Øª</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="protection.js"></script>
    <script src="js/modules/prompt_builder.js"></script>
</head>

<body class="dark-theme">
    <div class="bg-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div class="container" style="max-width: 900px;">
        <nav>
            <div class="logo-container">
                <div class="ripple-wrapper">
                    <div class="ripple"></div>
                    <img src="ØªÙ†Ø²ÙŠÙ„.jpg" id="mainLogo" alt="Athar">
                </div>
                <div>
                    <div class="logo">Ø£Ø«Ø±</div>
                    <div class="logo-slogan">Ù…Ø­ÙˆÙ„ Ø§Ù„Ø®Ø¨Ø±Ø§Øª Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</div>
                </div>
            </div>
            <a href="index.html" class="btn btn-ghost">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </nav>

        <div class="glass-card anim-fade-in" style="margin-top: 40px;">
            <h2 style="color: var(--primary); margin-bottom: 20px; font-weight: 900;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØµÙŠØ§ØºØ© Ø§Ù„Ø®Ø¨Ø±Ø§Øª</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">Ø­ÙˆÙ„ Ø®Ø¨Ø±Ø§ØªÙƒ Ù…Ù† Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø®Ø§Øµ Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ø¥Ù„Ù‰
                Ù…ØµØ·Ù„Ø­Ø§Øª ÙˆØµÙŠØ§ØºØ§Øª Ø§Ø­ØªØ±Ø§ÙÙŠØ© ØªÙ‚Ø¨Ù„Ù‡Ø§ Ø§Ù„Ù…Ù†Ø¸Ù…Ø§Øª Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©.</p>

            <div class="form-group">
                <label>Ø®Ø¨Ø±Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø¨Ø´ÙƒÙ„ Ø¨Ø³ÙŠØ·):</label>
                <textarea id="expInput"
                    placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙƒÙ†Øª Ø£Ø¯ÙŠØ± Ù…Ø­Ù„Ø§Ù‹ ØªØ¬Ø§Ø±ÙŠØ§Ù‹ ÙˆØ£Ø´Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ£Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª..."
                    style="min-height: 120px;"></textarea>
            </div>

            <button id="transformBtn" class="btn btn-primary"
                style="width: 100%; justify-content: center; padding: 18px; font-size: 1.1rem; border-radius: 16px;">
                Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ ğŸš€
            </button>
        </div>

        <div id="loader" style="display: none; margin: 40px 0; text-align: center;">
            <div class="loading-spinner"
                style="border: 4px solid var(--glass-border); border-top-color: var(--primary); width: 50px; height: 50px; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;">
            </div>
            <p style="color: var(--primary); font-weight: 700;">Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØµÙŠØ§ØºØ© 30 Ù†Ù‚Ø·Ø© Ù…Ù‡Ù†ÙŠØ©...</p>
        </div>

        <div id="resultArea" style="display: none;" class="anim-slide-up">
            <div class="glass-card" style="margin-top: 30px; border-color: var(--primary);">
                <h3 style="color: var(--primary); margin-bottom: 25px;"><i class="fas fa-magic"></i> Ø§Ù„ØµÙŠØ§ØºØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (30
                    Ù†Ù‚Ø·Ø©):</h3>
                <div id="transformContainer"></div>

                <div
                    style="margin-top: 50px; background: rgba(16, 185, 129, 0.05); padding: 30px; border-radius: 20px; border: 1px solid var(--accent);">
                    <h3 style="color: var(--accent); margin-bottom: 20px;"><i class="fas fa-key"></i> ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ©
                        Ù‚ÙˆÙŠØ©:</h3>
                    <div id="keywordsArea" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                </div>

                <button onclick="ProtectionManager.verify(() => window.print())" class="btn btn-ghost"
                    style="width: 100%; margin-top: 40px; justify-content: center;">
                    <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„Ù Ø§Ù„Ø®Ø¨Ø±Ø§Øª
                </button>
            </div>
        </div>
    </div>

    <footer class="main-footer">
        <div class="footer-credit">ØªØ·ÙˆÙŠØ± ÙˆØªÙ†ÙÙŠØ° Ø£. Ù†Ø¨ÙŠÙ„ Ø§Ù„Ø­Ù…ÙŠØ¯ &copy; 2025</div>
    </footer>

    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .transform-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .old-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            position: relative;
            padding-right: 20px;
        }

        .old-text::before {
            content: 'Ã—';
            position: absolute;
            right: 0;
            color: var(--danger);
        }

        .new-text {
            color: var(--text-primary);
            font-weight: 600;
            position: relative;
            padding-right: 20px;
        }

        .new-text::before {
            content: 'âœ“';
            position: absolute;
            right: 0;
            color: var(--accent);
        }

        .keyword-tag {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent);
            padding: 5px 15px;
            border-radius: 100px;
            font-size: 0.85rem;
            border: 1px solid var(--accent);
        }
    </style>

    <style>
        .file-upload-btn {
            background: var(--primary);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.3s;
            margin-right: 15px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            display: inline-flex;
        }

        .file-upload-btn:hover {
            transform: scale(1.1);
            background: #4f46e5;
        }

        .input-row {
            display: flex;
            align-items: flex-start;
        }
    </style>

    <script src="js/modules/file_processor.js"></script>
    <script src="protection.js"></script>
    <script src="js/global_settings.js"></script>
    <script>
        const BRIDGE_URL = "https://script.google.com/macros/s/AKfycbzSdWq5xiGZQZ9-DuaVh57f_3UKLuuYWukgIC3x2vtvt5d2VIyEv4yiJn93-hIrgLL9/exec";
        let uploadedText = "";

        // Add upload button dynamically or better yet, inject it into the structure
        const formGroup = document.querySelector('.form-group');
        if (formGroup && !document.querySelector('.file-upload-btn')) {
            const label = formGroup.querySelector('label');
            const container = document.createElement('div');
            container.className = 'input-row';

            const textArea = document.getElementById('expInput');
            textArea.parentNode.insertBefore(container, textArea);
            container.appendChild(textArea);

            const uploadLabel = document.createElement('label');
            uploadLabel.className = 'file-upload-btn';
            uploadLabel.htmlFor = 'fileUpload';
            uploadLabel.title = 'Ø§Ø±ÙØ¹ Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ø°Ø§ØªÙŠØ© (PDF)';
            uploadLabel.innerHTML = '<i class="fas fa-cloud-upload-alt"></i>';
            container.appendChild(uploadLabel);

            const input = document.createElement('input');
            input.type = 'file';
            input.id = 'fileUpload';
            input.accept = '.pdf,.docx,.doc,.txt';
            input.style.display = 'none';
            input.onchange = function () { handleFileUpload(this); };
            container.appendChild(input);
        }

        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const loader = document.getElementById('loader');
            const textArea = document.getElementById('expInput');

            textArea.placeholder = "Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù...";
            textArea.disabled = true;

            try {
                if (typeof fileProcessor === 'undefined') console.warn("FileProcessor logic loading...");

                const result = await fileProcessor.processFile(file, { extractText: true });
                uploadedText = result.text;

                textArea.value = `[Ù…Ù„Ù Ù…Ø±ÙÙ‚: ${file.name}]\n\n${uploadedText.substring(0, 500)}...\n(ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)`;
                textArea.disabled = false;

                // Auto start? Maybe wait for user to click button for manual control.
                // But let's verify readiness.

            } catch (e) {
                console.error(e);
                alert(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù: ${e.message}`);
                textArea.disabled = false;
                textArea.placeholder = "Ù…Ø«Ù„Ø§Ù‹: ÙƒÙ†Øª Ø£Ø¯ÙŠØ± Ù…Ø­Ù„Ø§Ù‹ ØªØ¬Ø§Ø±ÙŠØ§Ù‹...";
            }
        }

        document.getElementById('transformBtn').onclick = async () => {
            const manualText = document.getElementById('expInput').value;
            const content = uploadedText || manualText;

            if (!content || content.length < 10) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø®Ø¨Ø±Ø§ØªÙƒ Ø£Ùˆ Ø±ÙØ¹ Ù…Ù„Ù");

            const btn = document.getElementById('transformBtn');
            const loader = document.getElementById('loader');
            const resultArea = document.getElementById('resultArea');

            btn.disabled = true;
            loader.style.display = 'block';
            resultArea.style.display = 'none';

            // Scoped prompt to handle potentially large CV text
            const prompt = PromptBuilder.buildUnifiedPrompt('Ø®Ø¨Ø±Ø§Øª', content, {
                itemCount: 30,
                fileContent: uploadedText ? uploadedText : ''
            });

            try {
                const res = await fetch(`${BRIDGE_URL}?action=ai`, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: "You are an HR expert for International NGOs. Return valid JSON only." },
                            { role: "user", content: prompt }
                        ]
                    })
                });

                const bridgeRes = await res.json();
                if (bridgeRes.status === "error") throw new Error(bridgeRes.message);

                const aiResponse = bridgeRes.data;
                const cleanJson = aiResponse.replace(/```json\s*|```\s*/gi, "").trim();
                const jsonMatch = cleanJson.match(/\{[\s\S]*\}/);

                if (!jsonMatch) throw new Error("JSON_ERROR");
                const data = JSON.parse(jsonMatch[0]);
                if (data.error) throw new Error(data.error.message || "AI_ERROR");

                const container = document.getElementById('transformContainer');
                const list = data.items || data.transformations || data.points || [];

                if (list.length === 0) throw new Error("No data returned");

                container.innerHTML = list.map(t => `
                    <div class="transform-item anim-slide-up">
                        <div class="old-text">${t.q || t.old || 'Ø§Ù„Ø®Ø¨Ø±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©'}</div>
                        <div class="new-text">${t.a || t.new || 'Ø§Ù„ØµÙŠØ§ØºØ© Ø§Ù„Ù…Ø·ÙˆØ±Ø©'}</div>
                    </div>
                `).join('');

                const kwArea = document.getElementById('keywordsArea');
                kwArea.innerHTML = (data.keywords || []).map(k => `
                    <span class="keyword-tag">${k}</span>
                `).join('');

                resultArea.style.display = 'block';
            } catch (e) {
                console.error(e);
                alert(`ØªØ¹Ø°Ø± ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø®Ø¨Ø±Ø§Øª: ${e.message}`);
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        };
    </script>
</body>

</html>